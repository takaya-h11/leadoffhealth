# パスワード再発行運用ガイド

**対象**: 管理者
**最終更新**: 2025年11月10日

---

## 概要

法人担当者が初期パスワードを忘れた場合、管理者がパスワードを再発行し、**手動で法人担当者に伝える**機能です。

**重要**: パスワードは自動でメール送信されません。管理者が画面でパスワードを確認し、安全な方法（電話、対面など）で法人担当者に伝える必要があります。

---

## 機能の流れ

### 1. 法人担当者からの問い合わせ

法人担当者から「パスワードを忘れた」と連絡があった場合:

1. ユーザーのメールアドレスを確認
2. 法人担当者一覧からユーザーを探す
3. パスワード再発行を実施
4. 画面に表示されたパスワードを法人担当者に安全な方法で伝える

---

## 操作手順

### Step 1: 法人担当者一覧を開く

1. 管理者としてログイン
2. サイドバーから「法人担当者管理」をクリック
3. 対象ユーザーを検索または一覧から選択

**URL**: `/admin/company-users`

### Step 2: ユーザー詳細画面を開く

1. 対象ユーザーの行をクリックして詳細画面へ
2. または「編集」ボタンをクリック

**URL**: `/admin/company-users/[userId]`

### Step 3: パスワード再発行

1. 画面下部の「パスワード管理」セクションを確認
2. 「初期パスワード再発行」ボタンをクリック
3. 確認ダイアログで「再発行する」をクリック

**確認ダイアログ:**
```
このユーザーの初期パスワードを再発行してもよろしいですか？
新しいパスワードを手動で法人担当者に伝える必要があります。
```

**処理内容:**
- 新しいセキュアなパスワード（12文字）を自動生成
- `must_change_password` フラグを `true` に設定
- パスワード表示画面に遷移

### Step 4: パスワードを確認して伝える

再発行が完了すると、以下の情報が表示されます:

- **ユーザー名**: ◯◯様
- **メールアドレス**: user@example.com
- **初期パスワード**: `Abc123!@#xyz` （コピーボタン付き）

**表示内容:**

```
┌─────────────────────────────────────────┐
│ 初期パスワード再発行完了                  │
├─────────────────────────────────────────┤
│ ✓ パスワードを再発行しました              │
│   以下の情報を法人担当者に伝えてください。  │
│                                         │
│ ユーザー名: ◯◯様                        │
│ メールアドレス: user@example.com         │
│ 初期パスワード: [Abc123!@#xyz] [コピー]  │
│                                         │
│ ⚠️ 重要な注意事項                        │
│ • このパスワードは厳重に管理してください    │
│ • 法人担当者には安全な方法で伝えてください  │
│   (電話、対面など)                       │
│ • メールやチャットでの送信は避けてください  │
│ • ユーザーは初回ログイン時に必ず          │
│   パスワード変更が必要です                │
└─────────────────────────────────────────┘
```

### Step 5: 法人担当者に伝える

**推奨される連絡方法（セキュア順）:**

1. ✅ **電話** - 最もセキュア
2. ✅ **対面** - 最もセキュア
3. ✅ **ビデオ通話** - セキュア
4. ⚠️ **チャットツール** - 注意が必要（送信後すぐに削除）
5. ❌ **メール** - 非推奨（平文で残るため）

**伝える内容:**
```
お世話になっております。
初期パスワードを再発行いたしました。

【ログイン情報】
URL: https://your-app-url.com/login
メールアドレス: user@example.com
初期パスワード: Abc123!@#xyz

初回ログイン時に必ずパスワード変更をお願いいたします。
```

---

## 法人担当者の対応

パスワード再発行後、法人担当者は以下の手順でログインします:

### 1. メールを確認

受信したメールから新しい初期パスワードを確認します。

### 2. ログイン

1. ログイン画面にアクセス
2. メールアドレスと新しい初期パスワードを入力
3. ログインボタンをクリック

### 3. パスワード変更（強制）

初回ログイン時に自動的にパスワード変更画面が表示されます:

1. 新しいパスワードを入力（8文字以上）
2. パスワード確認を入力
3. 「パスワードを更新」ボタンをクリック

---

## トラブルシューティング

### Q1: パスワード再発行ボタンが見つからない

**A:** 以下を確認してください:

- 管理者としてログインしているか
- 法人担当者の詳細画面を開いているか（一覧画面にはボタンはありません）
- 対象ユーザーが法人担当者（`company_user`）であるか

### Q2: パスワード再発行後もログインできない

**A:** 以下を確認してください:

- メールアドレスが正しいか
- パスワードを正確に入力しているか（大文字・小文字を区別）
- スペースや改行が入っていないか（コピーボタンを使用推奨）
- アカウントが有効化されているか（`is_active = true`）

### Q3: パスワード表示画面を閉じてしまった

**A:** セキュリティ上、一度画面を閉じると再度パスワードを確認することはできません。もう一度パスワード再発行を実施してください。

### Q4: 法人担当者にパスワードを伝える最も安全な方法は？

**A:** 推奨順:
1. 電話（最も安全）
2. 対面
3. ビデオ通話
4. チャットツール（送信後すぐに削除）

メールでの送信は避けてください（平文で残るため）。

---

## セキュリティ考慮事項

### パスワードの強度

自動生成されるパスワードは以下の要件を満たします:

- 12文字
- 大文字・小文字・数字・記号を含む
- 読みにくい文字（I, l, O, 0, 1）を除外

### 初回ログイン時の強制変更

`must_change_password` フラグにより、以下の動作が保証されます:

- パスワード再発行後、初回ログイン時に必ずパスワード変更が求められる
- 管理者が発行したパスワードをそのまま使い続けることはできない

### 手動伝達の重要性

**なぜ自動メール送信ではないのか？**

- パスワードは平文でメールに含まれるため、メール送信は安全ではない
- メールは第三者に傍受されるリスクがある
- メールサーバーやクライアントに平文で保存される
- 管理者が手動で安全な方法（電話、対面）で伝えることで、より高いセキュリティを確保

### パスワード表示の一回性

- セキュリティのため、パスワードは一度しか表示されません
- URLパラメータにパスワードが含まれるため、ページを離れると再度確認できません
- 万が一パスワードを忘れた場合は、再度パスワード再発行を実施してください

---

## よくある質問

### Q: 何回でもパスワード再発行できますか？

**A:** はい、制限はありません。必要に応じて何度でも再発行できます。

### Q: 再発行したパスワードの有効期限は？

**A:** ありません。ただし、初回ログイン時に変更が必要です。

### Q: 管理者や整体師のパスワードも再発行できますか？

**A:** いいえ、この機能は法人担当者のみが対象です。管理者や整体師のパスワード再発行は別途実装が必要です。

---

## 技術仕様（参考）

### API Endpoint

```
POST /api/admin/users/[userId]/reset-password
```

### 処理フロー

1. 管理者権限チェック
2. 対象ユーザーが法人担当者かチェック
3. セキュアなパスワード生成（12文字）
4. Supabase Admin APIでパスワード更新
5. `must_change_password` フラグを `true` に設定
6. メール送信（Resend経由）

### 関連ファイル

- **API Route**: `src/app/api/admin/users/[userId]/reset-password/route.ts`
- **Server Action**: `src/app/(protected)/admin/company-users/actions.ts`
- **UI Component**: `src/app/(protected)/admin/company-users/[id]/action-buttons.tsx`
- **メール関数**: `src/lib/email.ts` → `sendPasswordResetEmail()`
- **パスワード生成**: `src/utils/password.ts` → `generateSecurePassword()`

---

## 将来機能

セルフサービスのパスワードリセット機能（法人担当者が自分でリセットできる機能）は、将来的に実装予定です。

詳細: [docs/future-features/password-reset-self-service.md](./future-features/password-reset-self-service.md)

---

**問い合わせ先**: システム管理者
