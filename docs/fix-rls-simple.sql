-- ============================================================================
-- RLS無限再帰エラーの修正（シンプル版）
-- ============================================================================
-- 無限再帰を完全に回避するため、ポリシー内でpublic.usersを参照しません
-- ============================================================================

-- ============================================================================
-- STEP 1: すべてのusersポリシーを削除
-- ============================================================================

DO $$
DECLARE
    policy_record RECORD;
BEGIN
    FOR policy_record IN
        SELECT policyname
        FROM pg_policies
        WHERE schemaname = 'public' AND tablename = 'users'
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS %I ON public.users', policy_record.policyname);
    END LOOP;
END $$;

-- ============================================================================
-- STEP 2: RLSを完全に無効化
-- ============================================================================
-- 開発中はRLSを無効にして、後で有効にします

ALTER TABLE public.users DISABLE ROW LEVEL SECURITY;

-- ============================================================================
-- STEP 3: 確認
-- ============================================================================

-- すべてのポリシーが削除されたか確認（結果が0件であればOK）
SELECT COUNT(*) as policy_count
FROM pg_policies
WHERE tablename = 'users';

-- RLSが無効になったか確認
SELECT
  schemaname,
  tablename,
  rowsecurity
FROM pg_tables
WHERE tablename = 'users';

-- ============================================================================
-- 完了！
-- ============================================================================
-- RLSを無効化したので、すべてのユーザーがusersテーブルを読めるようになります
-- これは開発環境では問題ありませんが、本番環境では適切なRLSポリシーが必要です
--
-- 本番環境用のRLSポリシーは、後で以下のように設定できます:
-- 1. ポリシー内でpublic.usersを参照しない
-- 2. auth.jwt()を使ってカスタムクレームからroleを取得
-- 3. またはservice roleを使ってRLSをバイパス
-- ============================================================================
